<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadastro İş Yönetim Sistemi - Giriş</title>
    <!-- Favicon Eklendi -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMkQ3MiIgZD0iTTEyIDIuMjVjLTMuOTYgMC03LjI1IDMuMjktNy4yNSA3LjI1IDAgNC41IDQuOCA5LjUgNi41IDExLjI1YS43NS43NSAwIDAwMS41IDBjMS43LTEuNzUgNi41LTYuNzUgNi41LTExLjI1QzE5LjI1IDUuNTQgMTUuOTYgMi4yNSAxMiAyLjI1em0wIDlhMi4yNSAyLjI1IDAgMTAwLTQuNSAyLjI1IDIuMjUgMCAwMDAgNC41eiIvPjwvc3ZnPg==" type="image/svg+xml">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) Kütüphanesi CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome Ikonları için -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Three.js (Animasyonlu Arka Plan için) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js (Grafikler için) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --fb-blue: #002D72;
            --fb-yellow: #FBB03B;
        }
        body {
            -webkit-text-size-adjust: 100%;
            margin: 0;
            overflow: hidden;
        }
        .bg-fb-blue { background-color: var(--fb-blue); }
        .bg-fb-yellow { background-color: var(--fb-yellow); }
        .text-fb-blue { color: var(--fb-blue); }
        .text-fb-yellow { color: var(--fb-yellow); }
        .border-fb-blue { border-color: var(--fb-blue); }
        .border-fb-yellow { border-color: var(--fb-yellow); }
        .btn-primary { background-color: var(--fb-blue); color: white; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #0041A1; }
        .btn-primary:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .btn-secondary { background-color: var(--fb-yellow); color: var(--fb-blue); font-weight: bold; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #FFC72C; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--fb-blue); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #0041A1; }
        .modal { transition: opacity 0.25s ease; z-index: 9999; }
        .modal.personel-detay-modal { z-index: 10001; }
        .modal.notlar-modal { z-index: 10002; }
        .spinner { border-top-color: var(--fb-yellow); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-syncing { background-color: #f59e0b; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .status-synced { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
        .status-idle { background-color: #6b7280; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .fa-sync.fa-spin { display: none; }
        .refresh-active .fa-sync:not(.fa-spin) { display: none; }
        .refresh-active .fa-sync.fa-spin { display: inline-block; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-in-out; }
        #login-box { background: rgba(255, 255, 255, 0.15); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 400px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); animation: fadeIn 0.7s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #login-box h2 { color: #ffffff; font-weight: bold; font-size: 1.8rem; margin-bottom: 10px; }
        #login-box p { color: #d1d5db; margin-bottom: 25px; }
        #login-box input[type="text"], #login-box input[type="password"] { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; color: #333; }
        #login-button { width: 100%; padding: 12px; font-size: 18px; border-radius: 8px; cursor: pointer; border: none; transition: background-color 0.3s; }
        #login-error { color: #fca5a5; margin-bottom: 15px; height: 20px; font-weight: bold; }
        .remember-me-container { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 20px; font-size: 14px; color: #e5e7eb; }
        .remember-me-container label { white-space: nowrap; }
        .remember-me-container input { width: auto; margin: 0 8px 0 0; }
        .login-copyright { margin-top: 20px; font-size: 12px; color: #9ca3af; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        #main-app-wrapper { display: none; height: 100vh; overflow-y: auto; }
        
        /* Not Listesi Stili */
        .not-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .not-item:hover { background-color: #f3f4f6; }
        .not-item.active { background-color: #ebf8ff; border-left-color: var(--fb-yellow); }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <canvas id="dynamic-bg"></canvas>

    <div id="login-overlay">
        <div id="login-box">
            <h2 class="text-fb-yellow"><i class="fa-solid fa-map-location-dot mr-2"></i>Kadastro İş Yönetim Sistemi</h2>
            <p>Devam etmek için lütfen giriş yapın.</p>
            <div id="login-error"></div>
            <input type="text" id="username" placeholder="Kullanıcı Adı" required>
            <input type="password" id="password" placeholder="Şifre" required>
            <div class="remember-me-container">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Beni Hatırla</label>
            </div>
            <button id="login-button" class="btn-primary font-bold">Giriş Yap</button>
            <p class="login-copyright">© Gökhan ELGÜL tarafından tasarlanmıştır.</p>
        </div>
    </div>

    <div id="main-app-wrapper">
        <div class="container mx-auto p-2 sm:p-4 lg:p-8">

            <header class="bg-fb-blue text-white p-4 rounded-t-lg shadow-lg grid grid-cols-1 md:grid-cols-3 items-center gap-2 md:gap-4">
                <h1 class="text-lg sm:text-2xl font-bold text-center md:text-left"><i class="fa-solid fa-map-location-dot mr-2"></i>Kadastro İş Yönetim Sistemi</h1>
                <div class="text-center text-xs text-gray-300">© Gökhan ELGÜL tarafından tasarlanmıştır.</div>
                <div class="text-right flex items-center gap-4 justify-self-center md:justify-self-end">
                    <div>
                        <span id="loggedInUser" class="text-sm font-semibold block"></span>
                        <span class="text-xs font-mono">v3.19.1 (Hata Giderme)</span>
                    </div>
                    <button onclick="window.showNotlarModal()" class="bg-fb-yellow text-fb-blue hover:bg-yellow-400 font-bold py-2 px-3 rounded-lg text-sm transition-colors" title="Not Defteri">
                        <i class="fa-regular fa-note-sticky"></i>
                    </button>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm" title="Çıkış Yap">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </header>

            <main class="bg-white p-2 sm:p-6 lg:p-8 rounded-lg shadow-lg mt-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-gray-50 p-4 rounded-lg border shadow-sm grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-2"><h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Yeni İş Kaydı</h3></div>
                        <div class="sm:col-span-2"><label for="kayitNo" class="block text-sm font-medium text-gray-700">Kayıt No (MEGSİS)</label><input type="text" id="kayitNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                        <div><label for="tarih" class="block text-sm font-medium text-gray-700">Tarih</label><input type="date" id="tarih" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                        <div><label for="birim" class="block text-sm font-medium text-gray-700">Birim</label><select id="birim" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                        <div><label for="parselSayisi" class="block text-sm font-medium text-gray-700">Parsel Sayısı</label><input type="number" id="parselSayisi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                        <div class="sm:col-span-2"><label for="isTuru" class="block text-sm font-medium text-gray-700">İş Türü</label><select id="isTuru" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                        <div class="sm:col-span-2">
                            <button id="isiAktarBtn" class="w-full btn-primary font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center" disabled>
                                <span id="addBtnText"><i class="fa-solid fa-plus mr-2"></i>İşi Ekle ve Kaydet</span>
                                <span id="addSpinner" class="hidden"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Ekleniyor...</span>
                            </button>
                        </div>
                    </div>
                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-lg border shadow-sm">
                        <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Personel Seçimi</h3>
                        <div><label for="personelSec" class="block text-sm font-medium text-gray-700">Personel</label><select id="personelSec" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                        <div class="mt-2 flex gap-2"><button id="personelEkleBtn" class="flex-grow btn-secondary py-2 px-4 rounded-lg text-sm">Ekle <i class="fa-solid fa-arrow-down ml-1"></i></button></div>
                        <div class="mt-4"><label for="secilenPersoneller" class="block text-sm font-medium text-gray-700">Görevli Personeller</label><textarea id="secilenPersoneller" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm" readonly></textarea></div>
                        <div class="mt-2 flex gap-2"><button id="personelTemizleBtn" class="flex-grow bg-red-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-700">Temizle <i class="fa-solid fa-trash ml-1"></i></button></div>
                    </div>
                </div>

                <div class="my-8">
                    <div class="flex justify-between items-center border-b-2 border-fb-yellow pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-fb-blue">Personel İş Yükü</h3>
                        <button onclick="window.showYillikArsivModal()" class="text-sm font-bold text-fb-blue hover:text-fb-yellow underline">
                            <i class="fa-solid fa-calendar-days mr-1"></i>Yıllık Arşiv Özeti
                        </button>
                    </div>
                     
                    <div class="flex flex-col sm:flex-row gap-4 mb-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="flex-1">
                            <label for="workloadUnitFilter" class="block text-xs font-bold text-fb-blue uppercase">Birim Bazlı Filtre</label>
                            <select id="workloadUnitFilter" class="w-full mt-1 p-2 text-sm border border-gray-300 rounded focus:ring-fb-blue focus:border-fb-blue">
                                <option value="">TÜM BİRİMLER</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="workloadYearFilter" class="block text-xs font-bold text-fb-blue uppercase">Yıl</label>
                            <select id="workloadYearFilter" class="w-full mt-1 p-2 text-sm border border-gray-300 rounded focus:ring-fb-blue focus:border-fb-blue">
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="workloadMonthFilter" class="block text-xs font-bold text-fb-blue uppercase">Ay</label>
                            <select id="workloadMonthFilter" class="w-full mt-1 p-2 text-sm border border-gray-300 rounded focus:ring-fb-blue focus:border-fb-blue">
                                <option value="">TÜM ZAMANLAR</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="border rounded-lg">
                            <button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-fb-blue focus:outline-none">
                                <span>Mühendisler</span>
                                <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content">
                                <table class="min-w-full">
                                    <tbody id="muhendisIsYukuListesi" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="border rounded-lg">
                            <button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-fb-blue focus:outline-none">
                                <span>Tekniker / Teknisyenler</span>
                                <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content">
                                <table class="min-w-full">
                                    <tbody id="teknisyenIsYukuListesi" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="border rounded-lg">
                            <button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-fb-blue focus:outline-none">
                                <span>İş Türlerine Göre Dağılım</span>
                                <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content">
                                <table class="min-w-full">
                                    <tbody id="isTuruDagilimListesi" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4 flex-grow">İş Listesi</h3>
                        <div id="syncStatus" class="flex items-center text-sm text-gray-600">
                            <span id="statusDot" class="status-dot status-idle"></span>
                            <span id="statusText">Başlatılıyor...</span>
                        </div>
                        <button id="refreshBtn" class="p-2 text-gray-600 hover:text-fb-blue transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Listeyi Yenile">
                            <i class="fa-solid fa-sync fa-spin"></i>
                            <i class="fa-solid fa-sync"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto bg-white rounded-lg shadow mt-4 relative">
                        <table class="w-full divide-y divide-gray-200 table-fixed">
                            <thead class="bg-fb-blue sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-24">Kayıt No</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-28">Tarih</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-28">Birim</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-20">Parsel</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-40">İş</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Personeller</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider w-20">İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="kayitListesi" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="p-4 text-center text-gray-500">Giriş bekleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <footer class="mt-8 pt-6 border-t-2 border-gray-200 flex flex-wrap gap-4 justify-center">
                    <button id="excelAktarBtn" class="btn-secondary py-2 px-5 rounded-lg shadow-md"><i class="fa-solid fa-file-excel mr-2"></i>Excel'e İndir</button>
                </footer>
            </main>

        </div>
    </div>

    <!-- Modallar -->
    <div id="infoModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0"><div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closeInfoModal()"></div><div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"><div class="modal-content py-4 text-left px-6"><div class="flex justify-between items-center pb-3"><p class="text-2xl font-bold text-fb-blue">Bilgilendirme</p><div onclick="window.closeInfoModal()" class="cursor-pointer z-50"><svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg></div></div><p id="infoModalText" class="text-gray-700"></p><div class="flex justify-end pt-2"><button onclick="window.closeInfoModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue">Tamam</button></div></div></div></div>
    <div id="confirmModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0"><div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div><div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"><div class="modal-content py-4 text-left px-6"><div class="flex justify-between items-center pb-3"><p class="text-2xl font-bold text-red-600">Onay Gerekiyor</p></div><p id="confirmModalText" class="text-gray-700"></p><div class="flex justify-end pt-4 gap-4"><button id="confirmCancelBtn" class="px-4 bg-gray-300 p-2 rounded-lg text-gray-800 hover:bg-gray-400">İptal</button><button id="confirmOkBtn" class="px-4 bg-red-600 p-2 rounded-lg text-white hover:bg-red-700">Evet, Sil</button></div></div></div></div>

    <div id="personelDetayModal" class="modal personel-detay-modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closePersonelDetayModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="personelDetayAdi" class="text-2xl font-bold text-fb-blue">Personel Detayı</p>
                    <div onclick="window.closePersonelDetayModal()" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="personelDetayList" class="my-4 p-2 max-h-64 overflow-y-auto"></div>
                <div class="flex justify-end pt-2">
                    <button onclick="window.closePersonelDetayModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- İş Türü Detay Modalı -->
    <div id="isTuruDetayModal" class="modal personel-detay-modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closeIsTuruDetayModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="isTuruDetayAdi" class="text-2xl font-bold text-fb-blue">İş Türü Detayı</p>
                    <div onclick="window.closeIsTuruDetayModal()" class="cursor-pointer z-50 hover:text-red-500">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="isTuruDetayList" class="my-4 p-2 max-h-[60vh] overflow-y-auto pr-2"></div>
                <div class="flex justify-end pt-2 mt-2 border-t border-gray-200">
                    <button onclick="window.closeIsTuruDetayModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue transition-colors">Kapat</button>
                </div>
            </div>
        </div>
    </div>
     
    <div id="yillikArsivModal" class="modal personel-detay-modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closeYillikArsivModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-fb-blue">Yıllık İş Özeti</p>
                    <div onclick="window.closeYillikArsivModal()" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="yillikArsivList" class="my-4 p-2 max-h-64 overflow-y-auto"></div>
                <div class="flex justify-end pt-2">
                    <button onclick="window.closeYillikArsivModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notlar Modalı -->
    <div id="notlarModal" class="modal notlar-modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closeNotlarModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded shadow-lg z-50 flex flex-col" style="height: 80vh;">
            <div class="modal-content py-4 px-6 flex flex-col h-full relative">
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <p class="text-2xl font-bold text-fb-blue"><i class="fa-regular fa-note-sticky mr-2 text-fb-yellow"></i>Ortak Not Defteri</p>
                    <div id="notSyncStatus" class="text-sm text-gray-500 font-semibold ml-4 mr-auto hidden">
                        <i class="fa-solid fa-spinner fa-spin mr-1"></i>Senkronize ediliyor...
                    </div>
                    <div onclick="window.closeNotlarModal()" class="cursor-pointer z-50 text-gray-600 hover:text-red-500">
                        <i class="fa-solid fa-times text-2xl"></i>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row flex-grow mt-4 gap-4 overflow-hidden">
                    <!-- Sol Panel: Not Listesi -->
                    <div class="w-full md:w-1/3 flex flex-col border-r pr-2 md:pr-4">
                        <button onclick="window.yeniNotOlustur()" class="w-full btn-primary py-2 rounded-lg mb-4 shadow"><i class="fa-solid fa-plus mr-2"></i>Yeni Not Ekle</button>
                        <div id="notlarListesiContainer" class="overflow-y-auto flex-grow pr-2 space-y-2">
                            <!-- Notlar buraya yüklenecek -->
                        </div>
                    </div>

                    <!-- Sağ Panel: Not Düzenleyici -->
                    <div class="w-full md:w-2/3 flex flex-col pl-0 md:pl-2 hidden" id="notEditorAlan">
                        <input type="hidden" id="aktifNotId">
                        <input type="text" id="notBaslik" placeholder="Not Başlığı..." class="w-full p-3 mb-4 border rounded shadow-sm text-lg font-bold focus:ring-fb-blue focus:border-fb-blue outline-none text-gray-800">
                        <textarea id="notIcerik" placeholder="Notunuzu buraya yazın..." class="w-full p-3 flex-grow border rounded shadow-sm resize-none focus:ring-fb-blue focus:border-fb-blue outline-none text-gray-700"></textarea>
                        
                        <div class="flex justify-between items-center mt-4 border-t pt-4">
                            <span id="notYazarBilgisi" class="text-xs text-gray-400 italic"></span>
                            <div class="flex gap-2">
                                <button id="notSilBtn" onclick="window.notSil()" class="bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg transition-colors hidden"><i class="fa-solid fa-trash mr-2"></i>Sil</button>
                                <button onclick="window.notKaydet()" class="btn-secondary px-6 py-2 rounded-lg shadow"><i class="fa-solid fa-save mr-2"></i>Kaydet</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sağ Panel: Boş Durum -->
                    <div id="notBosDurum" class="w-full md:w-2/3 flex flex-col items-center justify-center text-gray-400">
                        <i class="fa-regular fa-folder-open text-6xl mb-4 opacity-50"></i>
                        <p class="text-lg">Görüntülemek veya düzenlemek için bir not seçin.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GITHUB_OWNER = 'gokhangeo';
        const GITHUB_REPO = 'isyonetim';
        const GITHUB_PATH = 'isyonetim.xlsx';
        const GITHUB_NOTES_PATH = 'notlar.json';
        const TOKEN_PART_1 = 'ghp_2KS6iY7t1ka6bKyHwONJ';
        const TOKEN_PART_2 = 'kXdwOUVhrU3PqlSX';

        const users = {
            "mersinisyonetim": { password: "334450", role: "admin", ilce: "Tümü" },
            "mersin": { password: "503344", role: "ilce", ilce: "Merkez İlçe", personelBirimAdi: "Merkez" },
            "anamur": { password: "503345", role: "ilce", ilce: "Anamur" },
            "silifke": { password: "503346", role: "ilce", ilce: "Silifke" },
            "erdemli": { password: "503347", role: "ilce", ilce: "Erdemli" },
            "mut": { password: "503348", role: "ilce", ilce: "Mut" },
            "tarsus": { password: "503349", role: "ilce", ilce: "Tarsus" }
        };

        const isiAktarBtn = document.getElementById('isiAktarBtn');
        const addBtnText = document.getElementById('addBtnText');
        const addSpinner = document.getElementById('addSpinner');
        const personelSec = document.getElementById('personelSec');
        const isTuru = document.getElementById('isTuru');
        const birim = document.getElementById('birim');
        const kayitListesi = document.getElementById('kayitListesi');
        const secilenPersoneller = document.getElementById('secilenPersoneller');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const refreshBtn = document.getElementById('refreshBtn');
        const loggedInUserSpan = document.getElementById('loggedInUser');
        const logoutBtn = document.getElementById('logoutBtn');
        const muhendisIsYukuListesi = document.getElementById('muhendisIsYukuListesi');
        const teknisyenIsYukuListesi = document.getElementById('teknisyenIsYukuListesi');
        const isTuruDagilimListesi = document.getElementById('isTuruDagilimListesi');
        const workloadUnitFilter = document.getElementById('workloadUnitFilter');
        const workloadMonthFilter = document.getElementById('workloadMonthFilter');
        const workloadYearFilter = document.getElementById('workloadYearFilter');
        const yillikArsivModal = document.getElementById('yillikArsivModal');

        let tumKayitlar = [];
        let personelListesi = [], isListesi = [], birimListesi = [];
        let personelDataList = [];
        let originalWorkbook = null;
        let fileSHA = null;
        let silinecekKayitIndex = null;
        let isSyncing = false;
        let currentUser = null;
        let globalIsYuku = new Map(); 
        let globalIsTuru = new Map(); 

        let notlar = [];
        let notlarFileSHA = null;

        const infoModal = document.getElementById('infoModal');
        const infoModalText = document.getElementById('infoModalText');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const personelDetayModal = document.getElementById('personelDetayModal');
        const personelDetayAdi = document.getElementById('personelDetayAdi');
        const isTuruDetayModal = document.getElementById('isTuruDetayModal');
        const isTuruDetayAdi = document.getElementById('isTuruDetayAdi');
        const notlarModal = document.getElementById('notlarModal'); 

        window.closeInfoModal = () => infoModal.classList.add('opacity-0', 'pointer-events-none');
        window.showInfoModal = (text, isError = false) => {
            infoModalText.textContent = text;
            infoModal.querySelector('p.text-2xl').className = isError ? "text-2xl font-bold text-red-600" : "text-2xl font-bold text-fb-blue";
            infoModal.classList.remove('opacity-0', 'pointer-events-none');
        };
        const closeConfirmModal = () => confirmModal.classList.add('opacity-0', 'pointer-events-none');
        window.showConfirmModal = (text, index) => {
            silinecekKayitIndex = index;
            confirmModalText.textContent = text;
            confirmModal.classList.remove('opacity-0', 'pointer-events-none');
        };
         
        window.closePersonelDetayModal = () => {
            personelDetayModal.classList.add('opacity-0', 'pointer-events-none');
        };
         
        window.showPersonelDetayModal = (displayText) => {
            const data = globalIsYuku.get(displayText);
            if (!data) return;

            personelDetayAdi.textContent = `${data.name} İş Dağılımı`;
            const listContainer = document.getElementById('personelDetayList');
             
            const isTuruArray = Object.entries(data.isTuruData);
            isTuruArray.sort((a, b) => b[1] - a[1]);

            if (isTuruArray.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500 text-center">Bu personele ait iş bulunamadı.</p>`;
                 personelDetayModal.classList.remove('opacity-0', 'pointer-events-none');
                 return;
            }
             
            const maxCount = isTuruArray[0][1];

            let html = '<div class="space-y-3">';
            for (const [isTuru, count] of isTuruArray) {
                const barWidthPercent = Math.max((count / maxCount) * 100, 15);
                html += `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <span class="col-span-5 text-sm font-medium text-gray-800 truncate" title="${isTuru}">${isTuru}</span>
                        <div class="col-span-7 bg-gray-200 rounded-full h-6">
                            <div class="bg-fb-blue h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500 ease-out" style="width: ${barWidthPercent}%;">
                                <span class="text-sm font-bold text-white">${count}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            listContainer.innerHTML = html;
            personelDetayModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        window.closeIsTuruDetayModal = () => {
            isTuruDetayModal.classList.add('opacity-0', 'pointer-events-none');
        };

        window.showIsTuruDetayModal = (isTuruAdi) => {
            const data = globalIsTuru.get(isTuruAdi);
            if (!data) return;

            isTuruDetayAdi.textContent = `${isTuruAdi} Detayı`;
            const listContainer = document.getElementById('isTuruDetayList');

            const personelArray = Array.from(data.personnel.entries());

            if (personelArray.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500 text-center">Bu iş türüne atanmış personel bulunamadı.</p>`;
                 isTuruDetayModal.classList.remove('opacity-0', 'pointer-events-none');
                 return;
            }

            const muhendisler = [];
            const teknisyenler = [];
            let maxCount = 1;

            personelArray.forEach(([isim, count]) => {
                if (count > maxCount) maxCount = count;
                const isMuhuhendis = isim.toLowerCase().includes('mühendis');
                if (isMuhuhendis) {
                    muhendisler.push([isim, count]);
                } else {
                    teknisyenler.push([isim, count]);
                }
            });

            muhendisler.sort((a, b) => b[1] - a[1]);
            teknisyenler.sort((a, b) => b[1] - a[1]);

            const renderBarGroup = (grupAdi, arr) => {
                if (arr.length === 0) return '';
                let html = `<div class="mb-5"><h4 class="font-bold text-gray-700 border-b-2 border-fb-yellow inline-block pb-1 mb-3">${grupAdi}</h4><div class="space-y-3">`;
                for (const [personel, count] of arr) {
                     const barWidthPercent = Math.max((count / maxCount) * 100, 10);
                    html += `
                        <div class="grid grid-cols-12 gap-2 items-center">
                            <span class="col-span-5 text-sm font-medium text-gray-800 truncate" title="${personel}">${personel}</span>
                            <div class="col-span-7 bg-gray-200 rounded-full h-6">
                                <div class="bg-fb-blue h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-500 ease-out" style="width: ${barWidthPercent}%;">
                                    <span class="text-sm font-bold text-white">${count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div></div>`;
                return html;
            };

            listContainer.innerHTML = renderBarGroup('Mühendisler', muhendisler) + renderBarGroup('Tekniker / Teknisyenler', teknisyenler);
            isTuruDetayModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        window.closeYillikArsivModal = () => {
             yillikArsivModal.classList.add('opacity-0', 'pointer-events-none');
        }

        window.showYillikArsivModal = () => {
            let allRecords = [];
            if (currentUser.role === 'admin') {
                const sheet = originalWorkbook.Sheets[findSheetName(originalWorkbook, 'Kayitlar')];
                if (sheet) allRecords = XLSX.utils.sheet_to_json(sheet);
            } else {
                allRecords = tumKayitlar;
            }

            const yearsMap = new Map();
            allRecords.forEach(rec => {
                 if(rec.Tarih) {
                    let dateObj;
                    if (typeof rec.Tarih === 'number') {
                         dateObj = new Date(Math.round((rec.Tarih - 25569)*86400*1000));
                    } else {
                        dateObj = new Date(rec.Tarih);
                    }
                     
                    if (!isNaN(dateObj)) {
                        const year = dateObj.getFullYear();
                        yearsMap.set(year, (yearsMap.get(year) || 0) + 1);
                    }
                }
            });

            const sortedYears = Array.from(yearsMap.entries()).sort((a,b) => b[0] - a[0]);
             const listContainer = document.getElementById('yillikArsivList');
             
             if (sortedYears.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-500 text-center">Kayıtlı veri bulunamadı.</p>`;
             } else {
                 let html = '<div class="space-y-3">';
                 const maxCount = sortedYears.length > 0 ? sortedYears.reduce((max, [_, count]) => count > max ? count : max, 0) : 1;

                 for(const [year, count] of sortedYears) {
                     const barWidthPercent = Math.max((count / maxCount) * 100, 20);
                     html += `
                        <div class="grid grid-cols-12 gap-2 items-center">
                            <span class="col-span-3 text-lg font-bold text-gray-800">${year}</span>
                            <div class="col-span-9 bg-gray-200 rounded-full h-8">
                                <div class="bg-fb-yellow h-8 rounded-full flex items-center justify-end pr-3 transition-all duration-500 ease-out" style="width: ${barWidthPercent}%;">
                                    <span class="text-base font-bold text-fb-blue">${count} İş</span>
                                </div>
                            </div>
                        </div>
                    `;
                 }
                 html += '</div>';
                 listContainer.innerHTML = html;
             }

             yillikArsivModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        const utf8_to_b64 = (str) => {
            return window.btoa(unescape(encodeURIComponent(str)));
        };

        const b64_to_utf8 = (str) => {
            return decodeURIComponent(escape(window.atob(str)));
        };

        const fetchNotlar = async () => {
            const GITHUB_TOKEN = TOKEN_PART_1 + TOKEN_PART_2;
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_NOTES_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                    cache: 'no-store'
                });
                
                if (response.status === 404) {
                    notlar = [];
                    notlarFileSHA = null;
                    renderNotlarList();
                    return;
                }
                
                if (!response.ok) throw new Error("Notlar alınamadı");
                
                const data = await response.json();
                notlarFileSHA = data.sha;
                
                let contentBase64 = data.content;
                const decodedString = b64_to_utf8(contentBase64.replace(/\n/g, ''));
                notlar = JSON.parse(decodedString);
                
                notlar.sort((a,b) => new Date(b.date) - new Date(a.date));
                
            } catch (error) {
                console.error("Not sistemi hatası:", error);
                notlar = [];
            }
            renderNotlarList();
        };

        const saveNotlarToGithub = async () => {
            const GITHUB_TOKEN = TOKEN_PART_1 + TOKEN_PART_2;
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_NOTES_PATH}`;
            
            const syncStatus = document.getElementById('notSyncStatus');
            syncStatus.classList.remove('hidden');

            try {
                const jsonStr = JSON.stringify(notlar, null, 2);
                const encodedContent = utf8_to_b64(jsonStr);
                
                const body = {
                    message: `[Kadastro App] Notlar guncellendi`,
                    content: encodedContent
                };
                if (notlarFileSHA) body.sha = notlarFileSHA;

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error("Not kaydedilemedi");

                const data = await response.json();
                notlarFileSHA = data.content.sha;
            } catch (error) {
                console.error("Not kaydetme hatası:", error);
                alert("Not kaydedilirken bir hata oluştu!");
            } finally {
                syncStatus.classList.add('hidden');
            }
        };

        const renderNotlarList = () => {
            const container = document.getElementById('notlarListesiContainer');
            container.innerHTML = '';
            
            if (notlar.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center mt-4">Henüz not eklenmemiş.</p>`;
                return;
            }

            const aktifId = document.getElementById('aktifNotId').value;

            notlar.forEach(not => {
                const div = document.createElement('div');
                div.className = `not-item p-3 border rounded-lg cursor-pointer flex flex-col gap-1 ${not.id === aktifId ? 'active' : 'bg-gray-50 border-gray-200'}`;
                div.onclick = () => window.notAc(not.id);
                
                let snippet = not.content.length > 40 ? not.content.substring(0, 40) + '...' : not.content;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm text-gray-800 truncate w-3/4">${not.title || 'Başlıksız Not'}</span>
                        <span class="text-xs text-gray-400 whitespace-nowrap">${not.date.split('T')[0]}</span>
                    </div>
                    <span class="text-xs text-gray-500 truncate">${snippet}</span>
                `;
                container.appendChild(div);
            });
        };

        window.showNotlarModal = () => {
            fetchNotlar(); 
            document.getElementById('notEditorAlan').classList.add('hidden');
            document.getElementById('notBosDurum').classList.remove('hidden');
            document.getElementById('aktifNotId').value = '';
            notlarModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        window.closeNotlarModal = () => {
            notlarModal.classList.add('opacity-0', 'pointer-events-none');
        };

        window.yeniNotOlustur = () => {
            document.getElementById('notBosDurum').classList.add('hidden');
            document.getElementById('notEditorAlan').classList.remove('hidden');
            
            document.getElementById('aktifNotId').value = '';
            document.getElementById('notBaslik').value = '';
            document.getElementById('notIcerik').value = '';
            document.getElementById('notYazarBilgisi').textContent = `Yazar: ${currentUser.ilce}`;
            document.getElementById('notSilBtn').classList.add('hidden');
            
            renderNotlarList();
            document.getElementById('notBaslik').focus();
        };

        window.notAc = (id) => {
            const not = notlar.find(n => n.id === id);
            if (!not) return;

            document.getElementById('notBosDurum').classList.add('hidden');
            document.getElementById('notEditorAlan').classList.remove('hidden');
            
            document.getElementById('aktifNotId').value = not.id;
            document.getElementById('notBaslik').value = not.title;
            document.getElementById('notIcerik').value = not.content;
            document.getElementById('notYazarBilgisi').textContent = `Yazar: ${not.author || 'Bilinmiyor'}`;
            document.getElementById('notSilBtn').classList.remove('hidden');
            
            renderNotlarList(); 
        };

        window.notKaydet = async () => {
            const id = document.getElementById('aktifNotId').value;
            const baslik = document.getElementById('notBaslik').value.trim();
            const icerik = document.getElementById('notIcerik').value.trim();

            if (!baslik && !icerik) return;

            if (id) {
                const index = notlar.findIndex(n => n.id === id);
                if (index !== -1) {
                    notlar[index].title = baslik;
                    notlar[index].content = icerik;
                    notlar[index].date = new Date().toISOString(); 
                }
            } else {
                const yeniId = 'not_' + Date.now() + Math.random().toString(36).substr(2, 5);
                const yeniNot = {
                    id: yeniId,
                    title: baslik || 'Başlıksız Not',
                    content: icerik,
                    date: new Date().toISOString(),
                    author: currentUser.ilce
                };
                notlar.unshift(yeniNot);
                document.getElementById('aktifNotId').value = yeniId;
                document.getElementById('notSilBtn').classList.remove('hidden');
            }

            renderNotlarList();
            await saveNotlarToGithub();
        };

        window.notSil = async () => {
            const id = document.getElementById('aktifNotId').value;
            if (!id) return;

            const onayla = confirm("Bu notu silmek istediğinize emin misiniz?");
            if (!onayla) return;

            notlar = notlar.filter(n => n.id !== id);
            document.getElementById('notEditorAlan').classList.add('hidden');
            document.getElementById('notBosDurum').classList.remove('hidden');
            
            renderNotlarList();
            await saveNotlarToGithub();
        };

        const handleLogin = () => {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            const loginBox = document.getElementById('login-box');
            const rememberMe = document.getElementById('rememberMe').checked;
             
            const username = usernameInput.value.toLowerCase().trim();
            const user = users[username];

            if (user && user.password === passwordInput.value) {
                const userData = { username, role: user.role, ilce: user.ilce, personelBirimAdi: user.personelBirimAdi };
                currentUser = userData;
                sessionStorage.setItem('loggedInUser', JSON.stringify(userData));
                 
                if (rememberMe) {
                    localStorage.setItem('rememberedUser', username);
                } else {
                    localStorage.removeItem('rememberedUser');
                }

                showMainApp();
            } else {
                loginError.textContent = 'Kullanıcı adı veya şifre hatalı!';
                loginBox.classList.add('shake');
                setTimeout(() => {
                    loginBox.classList.remove('shake');
                }, 500);
            }
        };

        const handleLogout = () => {
            sessionStorage.removeItem('loggedInUser');
            window.location.reload();
        };

        const showMainApp = () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('main-app-wrapper').style.display = 'block';
            initApp();
        };

        const checkLoginStatus = () => {
            const userData = sessionStorage.getItem('loggedInUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                document.getElementById('login-overlay').style.display = 'none';
                showMainApp();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                const rememberedUser = localStorage.getItem('rememberedUser');
                if (rememberedUser) {
                    document.getElementById('username').value = rememberedUser;
                    document.getElementById('rememberMe').checked = true;
                }

                const loginButton = document.getElementById('login-button');
                const passwordInput = document.getElementById('password');
                const usernameInput = document.getElementById('username');
                loginButton.addEventListener('click', handleLogin);
                passwordInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleLogin(); });
                usernameInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleLogin(); });
            }
        };

        const initAnimatedBackground = () => {
            const bgCanvas = document.getElementById('dynamic-bg');
            if (!bgCanvas) return;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: bgCanvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
             
            const generateGradient = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 512;
                const context = canvas.getContext('2d');
                const gradient = context.createLinearGradient(0, 0, 0, 512);
                gradient.addColorStop(0, '#020111');
                gradient.addColorStop(1, '#191970');
                context.fillStyle = gradient;
                context.fillRect(0, 0, 1, 512);
                return canvas;
            };
             
            scene.background = new THREE.CanvasTexture(generateGradient());

            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCnt = 5000;
            const posArray = new Float32Array(particlesCnt * 3);
            for(let i = 0; i < particlesCnt * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 15;
            }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
             
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.010, color: 0xffffff });
            const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particlesMesh);
             
            camera.position.z = 5;
             
            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (event) => { mouseX = event.clientX; mouseY = event.clientY; });
             
            const clock = new THREE.Clock();
             
            const animate = () => {
                requestAnimationFrame(animate);
                const elapsedTime = clock.getElapsedTime();
                particlesMesh.rotation.y = -0.05 * elapsedTime;
                if(mouseX > 0) {
                    particlesMesh.rotation.x = -mouseY * (elapsedTime * 0.00003);
                    particlesMesh.rotation.y += -mouseX * (elapsedTime * 0.00003);
                }
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });
        };

        const getApiUrl = () => `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;

        const updateSyncStatus = (status, text) => {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        };

        const setAddButtonState = (loading) => {
            isiAktarBtn.disabled = loading;
            addBtnText.classList.toggle('hidden', loading);
            addSpinner.classList.toggle('hidden', !loading);
        };
        
        const findSheetName = (workbook, targetName) => {
            if (!workbook || !workbook.SheetNames) return targetName;
            const normalizedTarget = targetName.trim().toLowerCase();
            return workbook.SheetNames.find(sheetName => sheetName.trim().toLowerCase() === normalizedTarget) || targetName;
        };

        const excelVerisiYukle = async () => {
            updateSyncStatus('status-syncing', 'Veriler Yükleniyor...');
            refreshBtn.classList.add('refresh-active');
            refreshBtn.disabled = true;
            kayitListesi.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">Veri yükleniyor...</td></tr>`;
             
            const GITHUB_TOKEN = TOKEN_PART_1 + TOKEN_PART_2;

            try {
                const response = await fetch(getApiUrl(), {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                    cache: 'no-store'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API Hatası: ${response.status} ${response.statusText}. Detay: ${errorText}`);
                }
                 
                const data = await response.json();
                fileSHA = data.sha;

                let contentBase64 = data.content;
                if (!contentBase64 && data.sha) {
                    const blobResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/blobs/${data.sha}`, {
                        headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                        cache: 'no-store'
                    });
                     if (blobResponse.ok) {
                        const blobData = await blobResponse.json();
                        contentBase64 = blobData.content;
                    }
                }

                if (!contentBase64) {
                     throw new Error("Dosya içeriği alınamadı. Dosya çok büyük veya erişim izni yok.");
                }

                const binaryString = atob(contentBase64.replace(/\n/g, ''));
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                 
                originalWorkbook = XLSX.read(bytes, { type: 'array' });
                 
                const islerSheetName = findSheetName(originalWorkbook, 'İşler');
                const islerSheet = originalWorkbook.Sheets[islerSheetName];
                if(islerSheet){
                    isListesi = XLSX.utils.sheet_to_json(islerSheet, { header: 1 }).flat().filter(Boolean);
                    isTuru.innerHTML = `<option value="">İş Türü Seçiniz</option>`;
                    isListesi.forEach(item => isTuru.innerHTML += `<option value="${item}">${item}</option>`);
                }

                if (currentUser.role === 'admin') {
                    const kayitlarSheetName = findSheetName(originalWorkbook, 'Kayitlar');
                    const kayitlarSheet = originalWorkbook.Sheets[kayitlarSheetName];
                     if (!kayitlarSheet) {
                        tumKayitlar = [];
                        console.warn("'Kayitlar' sayfası bulunamadı.");
                    } else {
                        tumKayitlar = XLSX.utils.sheet_to_json(kayitlarSheet);
                    }
                } else {
                    const ilceSheetName = findSheetName(originalWorkbook, currentUser.ilce);
                    const ilceSheet = originalWorkbook.Sheets[ilceSheetName];
                    if (!ilceSheet) {
                        tumKayitlar = [];
                        console.warn(`'${currentUser.ilce}' sayfası bulunamadı.`);
                    } else {
                        tumKayitlar = XLSX.utils.sheet_to_json(ilceSheet);
                    }
                }

                const personelSheetName = findSheetName(originalWorkbook, 'Personel');
                const personelSheet = originalWorkbook.Sheets[personelSheetName];
                if (personelSheet) {
                    personelDataList = [];
                    const personelRawData = XLSX.utils.sheet_to_json(personelSheet, { header: 1 });
                    const filterIlceName = (currentUser.role !== 'admin') 
                        ? (currentUser.personelBirimAdi || currentUser.ilce).toLowerCase() 
                        : null;

                    personelRawData.forEach((row, index) => {
                        if (index === 0 || !row || !row[0]) return;
                        const name = String(row[0]).trim();
                        const title = row[1] ? String(row[1]).trim() : '';
                        const personelBirim = (row[2] ? String(row[2]).trim() : '').toLowerCase();
                        const displayText = title ? `${name} (${title})` : name;
                        if (currentUser.role === 'admin' || personelBirim === filterIlceName) {
                             personelDataList.push({ 
                                name: name, 
                                title: title, 
                                displayText: displayText,
                                birim: row[2] ? String(row[2]).trim() : ''
                            });
                        }
                    });
                } else {
                    window.showInfoModal("'Personel' adında bir Excel sayfası bulunamadı.", true);
                }

                const loadSimpleSheetData = (targetSheetName, selectElement, list, placeholder) => {
                    const actualSheetName = findSheetName(originalWorkbook, targetSheetName);
                    const sheet = originalWorkbook.Sheets[actualSheetName];
                    
                    if (sheet) {
                        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat().filter(Boolean);
                        list.splice(0, list.length, ...data);
                        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                        if (currentUser.role === 'admin') {
                            list.forEach(item => selectElement.innerHTML += `<option value="${item}">${item}</option>`);
                        } else {
                            selectElement.innerHTML = `<option value="${currentUser.ilce}" selected>${currentUser.ilce}</option>`;
                            selectElement.disabled = true;
                        }
                    } else {
                        const availableSheets = originalWorkbook.SheetNames.join(', ');
                        window.showInfoModal(`'${targetSheetName}' adında bir Excel sayfası bulunamadı. Mevcut sayfalar: ${availableSheets}`, true);
                    }
                };
                 
                loadSimpleSheetData('Birim', birim, birimListesi, 'Birim Seçiniz');
                 
                kayitListesiniGuncelle();
                personelIsYukuGuncelle();
                updateSyncStatus('status-synced', `Güncel. Son Yükleme: ${new Date().toLocaleTimeString()}`);
                isiAktarBtn.disabled = false;

            } catch (error) {
                console.error('Excel dosyası okunurken hata:', error);
                let userErrorMessage = `Veri yükleme hatası: ${error.message}`;
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    userErrorMessage = "Ağ hatası: GitHub API'sine ulaşılamadı. Lütfen internet bağlantınızı kontrol edin veya daha sonra tekrar deneyin.";
                }
                window.showInfoModal(userErrorMessage, true);
                updateSyncStatus('status-error', 'Veri Yüklenemedi!');
                kayitListesi.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">Veri yüklenemedi. İnternet bağlantınızı veya Token'ı kontrol edin.</td></tr>`;
                isiAktarBtn.disabled = true;
            } finally {
                refreshBtn.classList.remove('refresh-active');
                refreshBtn.disabled = false;
            }
        };
         
        const updateGithubFile = async (workbook, message) => {
            const GITHUB_TOKEN = TOKEN_PART_1 + TOKEN_PART_2;
            const newWorkbookBinary = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });
            const newContentBase64 = btoa(newWorkbookBinary);

            const response = await fetch(getApiUrl(), {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    content: newContentBase64,
                    sha: fileSHA
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`GitHub API Hatası: ${response.status} ${response.statusText}. Detay: ${errorText}`);
            }

            const responseData = await response.json();
            fileSHA = responseData.content.sha;
            originalWorkbook = workbook;
        };

        const addNewRecordToGithub = async (yeniKayit) => {
            if (isSyncing) return;
            isSyncing = true;
            updateSyncStatus('status-syncing', 'Yeni kayıt ekleniyor...');

            try {
                const headers = ['Kayıt No', 'Tarih', 'Birim', 'Parsel Sayısı', 'İş', 'Personeller'];
                const ilceAdi = yeniKayit.Birim;

                const kayitlarSheetName = findSheetName(originalWorkbook, 'Kayitlar');
                const kayitlarSheet = originalWorkbook.Sheets[kayitlarSheetName] || XLSX.utils.aoa_to_sheet([headers]);
                const kayitlarData = XLSX.utils.sheet_to_json(kayitlarSheet);
                kayitlarData.push(yeniKayit);
                originalWorkbook.Sheets[kayitlarSheetName] = XLSX.utils.json_to_sheet(kayitlarData, { header: headers });

                const ilceSheetName = findSheetName(originalWorkbook, ilceAdi);
                const ilceSheet = originalWorkbook.Sheets[ilceSheetName] || XLSX.utils.aoa_to_sheet([headers]);
                const ilceData = XLSX.utils.sheet_to_json(ilceSheet);
                ilceData.push(yeniKayit);
                originalWorkbook.Sheets[ilceSheetName] = XLSX.utils.json_to_sheet(ilceData, { header: headers });

                await updateGithubFile(originalWorkbook, `[Kadastro App] Yeni kayıt eklendi: ${yeniKayit['Kayıt No']}`);
                updateSyncStatus('status-synced', 'Yeni kayıt başarıyla eklendi!');

            } catch (error) {
                console.error("Yeni kayıt ekleme hatası:", error);
                window.showInfoModal(`Kayıt eklenirken hata oluştu: ${error.message}`, true);
                updateSyncStatus('status-error', 'Kayıt eklenemedi!');
                await excelVerisiYukle();
            } finally {
                isSyncing = false;
            }
        };
         
        const deleteRecordFromGithub = async (kayitToDelete) => {
            if (isSyncing) return;
            isSyncing = true;
            updateSyncStatus('status-syncing', 'Kayıt siliniyor...');
             
            try {
                const kayitNo = kayitToDelete['Kayıt No'];
                const ilceAdi = kayitToDelete.Birim;
                const headers = ['Kayıt No', 'Tarih', 'Birim', 'Parsel Sayısı', 'İş', 'Personeller'];

                const kayitlarSheetName = findSheetName(originalWorkbook, 'Kayitlar');
                const kayitlarSheet = originalWorkbook.Sheets[kayitlarSheetName];
                if (kayitlarSheet) {
                    const kayitlarData = XLSX.utils.sheet_to_json(kayitlarSheet);
                    const updatedKayitlarData = kayitlarData.filter(row => row['Kayıt No'] != kayitNo);
                    originalWorkbook.Sheets[kayitlarSheetName] = XLSX.utils.json_to_sheet(updatedKayitlarData, { header: headers });
                }

                const ilceSheetName = findSheetName(originalWorkbook, ilceAdi);
                const ilceSheet = originalWorkbook.Sheets[ilceSheetName];
                if (ilceSheet) {
                    const ilceData = XLSX.utils.sheet_to_json(ilceSheet);
                    const updatedIlceData = ilceData.filter(row => row['Kayıt No'] != kayitNo);
                    originalWorkbook.Sheets[ilceSheetName] = XLSX.utils.json_to_sheet(updatedIlceData, { header: headers });
                }

                await updateGithubFile(originalWorkbook, `[Kadastro App] Kayıt silindi: ${kayitNo}`);
                updateSyncStatus('status-synced', 'Kayıt başarıyla silindi!');

            } catch (error) {
                console.error("Kayıt silme hatası:", error);
                window.showInfoModal(`Kayıt silinirken hata oluştu: ${error.message}`, true);
                updateSyncStatus('status-error', 'Kayıt silinemedi!');
                await excelVerisiYukle();
            } finally {
                isSyncing = false;
            }
        };

        const populateWorkloadFilters = () => {
            if (currentUser.role === 'admin') {
                workloadUnitFilter.innerHTML = '<option value="">TÜM BİRİMLER</option>';
                const uniqueUnits = [...new Set(birimListesi)].sort();
                uniqueUnits.forEach(unit => {
                    workloadUnitFilter.innerHTML += `<option value="${unit}">${unit}</option>`;
                });
                workloadUnitFilter.disabled = false;
            } else {
                workloadUnitFilter.innerHTML = `<option value="${currentUser.ilce}">${currentUser.ilce}</option>`;
                workloadUnitFilter.disabled = true;
            }

            let allRecords = [];
             if (currentUser.role === 'admin') {
                const sheet = originalWorkbook.Sheets[findSheetName(originalWorkbook, 'Kayitlar')];
                if (sheet) allRecords = XLSX.utils.sheet_to_json(sheet);
            } else {
                allRecords = tumKayitlar;
            }

            const uniqueMonths = new Set();
            const uniqueYears = new Set();

            allRecords.forEach(rec => {
                if(rec.Tarih) {
                    let dateObj;
                    if (typeof rec.Tarih === 'number') {
                         dateObj = new Date(Math.round((rec.Tarih - 25569)*86400*1000));
                    } else {
                        dateObj = new Date(rec.Tarih);
                    }
                     
                    if (!isNaN(dateObj)) {
                        const monthName = dateObj.toLocaleString('tr-TR', { month: 'long' });
                        uniqueMonths.add(monthName);
                        uniqueYears.add(dateObj.getFullYear());
                    }
                }
            });

            const sortedYears = [...uniqueYears].sort((a, b) => b - a);
             
            workloadYearFilter.innerHTML = ''; 
            const currentYear = new Date().getFullYear();
             
            if (!sortedYears.includes(currentYear)) {
                sortedYears.unshift(currentYear);
            }

            sortedYears.forEach(y => {
                const selected = y === currentYear ? 'selected' : '';
                workloadYearFilter.innerHTML += `<option value="${y}" ${selected}>${y}</option>`;
            });


            const monthsOrder = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const sortedMonths = [...uniqueMonths].sort((a, b) => monthsOrder.indexOf(a) - monthsOrder.indexOf(b));

            workloadMonthFilter.innerHTML = '<option value="">TÜM ZAMANLAR</option>';
            sortedMonths.forEach(m => {
                workloadMonthFilter.innerHTML += `<option value="${m}">${m}</option>`;
            });
        };

        const personelIsYukuGuncelle = () => {
            if (workloadYearFilter.options.length === 0) {
                populateWorkloadFilters();
            }

            const selectedUnit = workloadUnitFilter.value;
            const selectedMonth = workloadMonthFilter.value;
            const selectedYear = workloadYearFilter.value; 

            globalIsYuku.clear();
            globalIsTuru.clear();
            let allRecordsForWorkload = [];

            if (currentUser.role === 'admin') {
                const sheet = originalWorkbook.Sheets[findSheetName(originalWorkbook, 'Kayitlar')];
                if (sheet) allRecordsForWorkload = XLSX.utils.sheet_to_json(sheet);
            } else {
                allRecordsForWorkload = tumKayitlar;
            }

            personelDataList.forEach(p => globalIsYuku.set(p.displayText, { 
                count: 0, 
                title: p.title, 
                name: p.name,
                isTuruData: {}
            }));

            allRecordsForWorkload.forEach(kayit => {
                if (selectedUnit && kayit.Birim !== selectedUnit) return;

                if (kayit.Tarih) {
                     let dateObj;
                    if (typeof kayit.Tarih === 'number') {
                         dateObj = new Date(Math.round((kayit.Tarih - 25569)*86400*1000));
                    } else {
                        dateObj = new Date(kayit.Tarih);
                    }
                     
                    if (!isNaN(dateObj)) {
                        if (selectedYear && dateObj.getFullYear().toString() !== selectedYear) return;

                        const monthName = dateObj.toLocaleString('tr-TR', { month: 'long' });
                        if (selectedMonth && monthName !== selectedMonth) return;

                    } else {
                        return; 
                    }
                }

                const isTuru = kayit.İş;
                if(isTuru){
                     if (!globalIsTuru.has(isTuru)) {
                        globalIsTuru.set(isTuru, { count: 0, personnel: new Map() });
                    }
                    const jobData = globalIsTuru.get(isTuru);
                    jobData.count++;
                }

                if (kayit.Personeller && isTuru) {
                    const atananlar = String(kayit.Personeller).split(',').map(p => p.trim());
                    atananlar.forEach(atanan => {
                        if (globalIsYuku.has(atanan)) {
                            const data = globalIsYuku.get(atanan);
                            data.count++;
                            data.isTuruData[isTuru] = (data.isTuruData[isTuru] || 0) + 1;
                        }
                         
                        if (globalIsTuru.has(isTuru)) {
                             const jobData = globalIsTuru.get(isTuru);
                             jobData.personnel.set(atanan, (jobData.personnel.get(atanan) || 0) + 1);
                        }
                    });
                }
            });

            personelSec.innerHTML = '<option value="">Personel Seçiniz</option>';
            const muhendisler = [];
            const teknisyenler = [];
            personelDataList.forEach(personel => {
                const yuku = globalIsYuku.get(personel.displayText);
                const count = yuku ? yuku.count : 0;
                const personelWithCount = { ...personel, count: count };
                if (personel.title.toLowerCase().includes('mühendis')) muhendisler.push(personelWithCount);
                else if (personel.title.toLowerCase().includes('teknisyen') || personel.title.toLowerCase().includes('tekniker') || personel.title.toLowerCase().includes('kontrol memuru')) teknisyenler.push(personelWithCount);
            });
            muhendisler.sort((a, b) => b.count - a.count);
            teknisyenler.sort((a, b) => b.count - a.count);
             
            let muhendislerHtml = '<optgroup label="Mühendisler">';
            muhendisler.forEach(personel => muhendislerHtml += `<option value="${personel.displayText}">${personel.displayText} (${personel.count})</option>`);
            muhendislerHtml += '</optgroup>';
            personelSec.innerHTML += muhendislerHtml;

            let teknisyenlerHtml = '<optgroup label="Tekniker / Teknisyenler">';
            teknisyenler.forEach(personel => teknisyenlerHtml += `<option value="${personel.displayText}">${personel.displayText} (${personel.count})</option>`);
            teknisyenlerHtml += '</optgroup>';
            personelSec.innerHTML += teknisyenlerHtml;


            const gruplar = { muhendisler: [], teknisyenler: [] };
            globalIsYuku.forEach((data, displayText) => {
                if (data.count === 0 && currentUser.role !== 'admin' && !selectedUnit) {
                     if (!personelDataList.find(p => p.displayText === displayText)) return;
                }
                const personelYuku = { personel: data.name, isSayisi: data.count, displayText: displayText };
                if (data.title.toLowerCase().includes('mühendis')) gruplar.muhendisler.push(personelYuku);
                else if (data.title.toLowerCase().includes('teknisyen') || data.title.toLowerCase().includes('tekniker') || data.title.toLowerCase().includes('kontrol memuru')) gruplar.teknisyenler.push(personelYuku);
            });
             
            const populateTable = (tbody, data) => {
                tbody.innerHTML = '';
                data.sort((a, b) => b.isSayisi - a.isSayisi);
                if (data.length === 0) tbody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500 text-sm">Veri yok.</td></tr>`;
                let html = '';
                data.forEach(item => {
                    html += `<tr class="hover:bg-fb-yellow hover:bg-opacity-20 cursor-pointer" onclick="window.showPersonelDetayModal('${item.displayText}')"><td class="px-6 py-4 text-sm font-medium text-gray-900">${item.personel}</td><td class="px-6 py-4 text-sm text-gray-500 font-bold text-center">${item.isSayisi}</td></tr>`;
                });
                tbody.innerHTML = html;
            };

            populateTable(muhendisIsYukuListesi, gruplar.muhendisler);
            populateTable(teknisyenIsYukuListesi, gruplar.teknisyenler);

            const isTuruArray = Array.from(globalIsTuru.entries());
            isTuruArray.sort((a, b) => b[1].count - a[1].count);
            let isTuruHtml = '';
             if (isTuruArray.length === 0) isTuruHtml = `<tr><td colspan="2" class="p-4 text-center text-gray-500 text-sm">Kayıtlı iş bulunamadı.</td></tr>`;
            else isTuruArray.forEach(([name, data]) => isTuruHtml += `<tr class="hover:bg-fb-yellow hover:bg-opacity-20 cursor-pointer" onclick="window.showIsTuruDetayModal('${name.replace(/'/g, "\\'")}')"><td class="px-6 py-4 text-sm font-medium text-gray-900">${name}</td><td class="px-6 py-4 text-sm text-gray-500 font-bold text-center">${data.count}</td></tr>`);
            isTuruDagilimListesi.innerHTML = isTuruHtml;
        };
         
        workloadUnitFilter.addEventListener('change', personelIsYukuGuncelle);
        workloadMonthFilter.addEventListener('change', personelIsYukuGuncelle);
        workloadYearFilter.addEventListener('change', personelIsYukuGuncelle); 

        const kayitListesiniGuncelle = () => {
            kayitListesi.innerHTML = '';
            const sortedKayitlar = [...tumKayitlar].sort((a, b) => {
                const dateA = a.Tarih ? new Date(a.Tarih.split('.').reverse().join('-')) : new Date(0);
                const dateB = b.Tarih ? new Date(b.Tarih.split('.').reverse().join('-')) : new Date(0);
                if (isNaN(dateA.getTime())) return 1;
                if (isNaN(dateB.getTime())) return -1;
                return dateB - dateA;
            });

            if (sortedKayitlar.length === 0) {
                kayitListesi.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">Henüz kayıt eklenmemiş.</td></tr>`;
                return;
            }
            let tableHtml = '';
            sortedKayitlar.forEach((kayit) => {
                const originalIndex = tumKayitlar.findIndex(item => item['Kayıt No'] === kayit['Kayıt No']);
                const row = `
                    <tr class="hover:bg-fb-yellow hover:bg-opacity-20">
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 truncate">${kayit['Kayıt No'] || ''}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 truncate">${kayit.Tarih || ''}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 truncate">${kayit.Birim || ''}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 truncate text-center">${kayit['Parsel Sayısı'] || ''}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 truncate" title="${kayit.İş}">${kayit.İş || ''}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 whitespace-normal break-words">${kayit.Personeller || ''}</td>
                        <td class="px-3 py-3 text-sm font-medium text-center">
                            <button class="text-red-600 hover:text-red-900" onclick="window.sil(${originalIndex})"><i class="fa-solid fa-trash-alt"></i> Sil</button>
                        </td>
                    </tr>`;
                tableHtml += row;
            });
            kayitListesi.innerHTML = tableHtml;
        };
         
        window.sil = (index) => {
            if (index < 0 || index >= tumKayitlar.length) {
                window.showInfoModal("Silinmek istenen kayıt bulunamadı. Lütfen listeyi yenileyin.", true);
                return;
            }
            const kayitNo = tumKayitlar[index]['Kayıt No'] || 'isimsiz';
            window.showConfirmModal(`'${kayitNo}' numaralı kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`, index);
        };

        refreshBtn.addEventListener('click', excelVerisiYukle);
        logoutBtn.addEventListener('click', handleLogout);

        confirmOkBtn.addEventListener('click', async () => {
            if (silinecekKayitIndex !== null) {
                const kayitToDelete = tumKayitlar[silinecekKayitIndex];
                if (!kayitToDelete) {
                    window.showInfoModal("Silme hatası: Kayıt verisi bulunamadı.", true);
                    silinecekKayitIndex = null;
                    closeConfirmModal();
                    return;
                }
                 
                closeConfirmModal();
                 
                await deleteRecordFromGithub(kayitToDelete);

                tumKayitlar.splice(silinecekKayitIndex, 1);
                kayitListesiniGuncelle();
                personelIsYukuGuncelle();
                window.showInfoModal("Kayıt başarıyla silindi.");
                silinecekKayitIndex = null;
            }
        });
        confirmCancelBtn.addEventListener('click', closeConfirmModal);

        isiAktarBtn.addEventListener('click', async () => {
            const kayitNoInput = document.getElementById('kayitNo');
            const kayitNoValue = kayitNoInput.value.trim();

            if (!kayitNoValue) {
                window.showInfoModal('Kayıt No alanı boş bırakılamaz.', true);
                return;
            }
             
            let allRecords = [];
            if (originalWorkbook && originalWorkbook.Sheets[findSheetName(originalWorkbook, 'Kayitlar')]) {
                 allRecords = XLSX.utils.sheet_to_json(originalWorkbook.Sheets[findSheetName(originalWorkbook, 'Kayitlar')]);
            }
             
            if (allRecords.some(kayit => String(kayit['Kayıt No']).trim() === kayitNoValue)) {
                window.showInfoModal(`'${kayitNoValue}' numaralı kayıt zaten mevcut. Lütfen farklı bir numara girin.`, true);
                return;
            }

            const yeniKayit = {
                'Kayıt No': kayitNoValue,
                'Tarih': document.getElementById('tarih').value,
                'Birim': document.getElementById('birim').value,
                'Parsel Sayısı': document.getElementById('parselSayisi').value || 0,
                'İş': document.getElementById('isTuru').value,
                'Personeller': secilenPersoneller.value.replace(/\n/g, ', ')
            };

            if (!yeniKayit['İş'] || !yeniKayit['Personeller'] || !yeniKayit['Birim']) {
                window.showInfoModal('Lütfen Birim, İş Türü ve Personel alanlarını doldurun.', true);
                return;
            }

            setAddButtonState(true);
             
            await addNewRecordToGithub(yeniKayit);

            tumKayitlar.push(yeniKayit); // tumKayitlar'a da ekle (veya excelVerisiYukle() tekrar çağrılabilir)
            kayitListesiniGuncelle();
            personelIsYukuGuncelle();
             
            kayitNoInput.value = '';
            document.getElementById('parselSayisi').value = '';
            document.getElementById('isTuru').selectedIndex = 0;
            if(currentUser.role === 'admin') document.getElementById('birim').selectedIndex = 0;
            secilenPersoneller.value = '';
            window.showInfoModal("Yeni iş eklendi ve değişiklikler GitHub'a kaydedildi.");
             
            setAddButtonState(false);
        });
         
        document.getElementById('excelAktarBtn').addEventListener('click', () => {
            if (tumKayitlar.length === 0) {
                window.showInfoModal('Dışa aktarılacak kayıt bulunmuyor.', true); return;
            }
            const worksheet = XLSX.utils.json_to_sheet(tumKayitlar);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'İş Listesi');
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            XLSX.writeFile(workbook, `Kadastro_Is_Listesi_${currentUser.ilce}_${dateStr}.xlsx`);
        });

        document.getElementById('personelEkleBtn').addEventListener('click', () => { const secilen = personelSec.value; if (secilen && !secilenPersoneller.value.includes(secilen)) { secilenPersoneller.value += (secilenPersoneller.value ? '\n' : '') + secilen; } });
        document.getElementById('personelTemizleBtn').addEventListener('click', () => { secilenPersoneller.value = ''; });
         
        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('i');
                 
                icon.classList.toggle('rotate-180');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        const initApp = () => {
            if (currentUser) {
                loggedInUserSpan.textContent = `${currentUser.ilce} (${currentUser.role})`;
                document.getElementById('tarih').valueAsDate = new Date();
                excelVerisiYukle();
                fetchNotlar(); // Arka planda notları yükle
            } else {
                console.error("Kullanıcı bilgileri yüklenemedi, uygulama başlatılamıyor.");
                window.showInfoModal("Kritik hata: Kullanıcı bilgileri bulunamadı. Lütfen sayfayı yenileyin.", true);
            }
        };
         
        initAnimatedBackground();
        checkLoginStatus();
    });
    </script>
</body>
</html>
