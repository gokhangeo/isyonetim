<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadastro İş Yönetim Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) Kütüphanesi CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome Ikonları için -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Fenerbahçe Teması için özel renkler */
        :root {
            --fb-blue: #002D72;
            --fb-yellow: #FBB03B;
        }
        .bg-fb-blue { background-color: var(--fb-blue); }
        .bg-fb-yellow { background-color: var(--fb-yellow); }
        .text-fb-blue { color: var(--fb-blue); }
        .text-fb-yellow { color: var(--fb-yellow); }
        .border-fb-blue { border-color: var(--fb-blue); }
        .border-fb-yellow { border-color: var(--fb-yellow); }
        .btn-primary {
            background-color: var(--fb-blue);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0041A1; /* Biraz daha açık mavi */
        }
        .btn-secondary {
            background-color: var(--fb-yellow);
            color: var(--fb-blue);
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #FFC72C; /* Biraz daha açık sarı */
        }
        /* Kaydırma çubuğu stilleri */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--fb-blue);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #0041A1;
        }
        /* Modal Stilleri */
        .modal {
            transition: opacity 0.25s ease;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Başlık -->
        <header class="bg-fb-blue text-white p-4 rounded-t-lg shadow-lg flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold">
                <i class="fa-solid fa-map-location-dot mr-2"></i>Kadastro İş Yönetim Sistemi
            </h1>
            <span class="text-xs font-mono">v1.1.0</span>
        </header>

        <main class="bg-white p-4 sm:p-6 lg:p-8 rounded-b-lg shadow-lg">

            <!-- Form Alanı -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                
                <!-- Sol Sütun: İş Bilgileri -->
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3">
                        <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Yeni İş Kaydı</h3>
                    </div>
                    <div>
                        <label for="kayitNo" class="block text-sm font-medium text-gray-700">Kayıt No (MEGSİS)</label>
                        <input type="text" id="kayitNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                    </div>
                    <div>
                        <label for="tarih" class="block text-sm font-medium text-gray-700">Tarih</label>
                        <input type="date" id="tarih" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                    </div>
                    <div>
                        <label for="birim" class="block text-sm font-medium text-gray-700">Birim</label>
                        <select id="birim" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                            <option>Yükleniyor...</option>
                        </select>
                    </div>
                    <div>
                        <label for="dosyaSayisi" class="block text-sm font-medium text-gray-700">Dosya Sayısı</label>
                        <input type="number" id="dosyaSayisi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                    </div>
                    <div>
                        <label for="parselSayisi" class="block text-sm font-medium text-gray-700">Parsel Sayısı</label>
                        <input type="number" id="parselSayisi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                    </div>
                    <div class="sm:col-span-2 md:col-span-1">
                        <label for="isTuru" class="block text-sm font-medium text-gray-700">İş Türü</label>
                        <select id="isTuru" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                            <option>Yükleniyor...</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 md:col-span-3">
                         <button id="isiAktarBtn" class="w-full btn-primary font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fa-solid fa-plus mr-2"></i>İşi Aktar
                        </button>
                    </div>
                </div>

                <!-- Sağ Sütun: Personel Seçimi -->
                <div class="lg:col-span-1 bg-gray-50 p-4 rounded-lg border">
                     <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Personel Seçimi</h3>
                    <div>
                        <label for="personelSec" class="block text-sm font-medium text-gray-700">Personel</label>
                        <select id="personelSec" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                            <option>Yükleniyor...</option>
                        </select>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button id="personelEkleBtn" class="flex-grow btn-secondary py-2 px-4 rounded-lg text-sm">Ekle <i class="fa-solid fa-arrow-down ml-1"></i></button>
                    </div>
                    <div class="mt-4">
                        <label for="secilenPersoneller" class="block text-sm font-medium text-gray-700">Görevli Personeller</label>
                        <textarea id="secilenPersoneller" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm" readonly></textarea>
                    </div>
                     <div class="mt-2 flex gap-2">
                        <button id="personelTemizleBtn" class="flex-grow bg-red-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-700">Temizle <i class="fa-solid fa-trash ml-1"></i></button>
                    </div>
                </div>
            </div>

            <!-- Kayıt Listesi -->
            <div>
                <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">İş Listesi</h3>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-fb-blue">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Kayıt No</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Personeller</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Birim</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">İş</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Dosya Sayısı</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Parsel Sayısı</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Tarih</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="kayitListesi" class="bg-white divide-y divide-gray-200">
                            <!-- Kayıtlar buraya dinamik olarak eklenecek -->
                            <tr><td colspan="8" class="p-4 text-center text-gray-500">Veri yükleniyor veya kayıt bulunamadı...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alt Butonlar -->
            <footer class="mt-8 pt-6 border-t-2 border-gray-200 flex flex-wrap gap-4 justify-center">
                <button id="excelAktarBtn" class="btn-primary py-2 px-5 rounded-lg shadow-md hover:shadow-lg"><i class="fa-solid fa-file-excel mr-2"></i>Excel'e Aktar</button>
                <button onclick="showInfoModal('Bu özellik yakında eklenecektir.')" class="bg-gray-500 text-white py-2 px-5 rounded-lg shadow-md hover:bg-gray-600"><i class="fa-solid fa-list-check mr-2"></i>Tüm İşlemleri Gör</button>
                <button onclick="showInfoModal('Bu özellik yakında eklenecektir.')" class="bg-gray-500 text-white py-2 px-5 rounded-lg shadow-md hover:bg-gray-600"><i class="fa-solid fa-percent mr-2"></i>Puantaj</button>
                <button onclick="showInfoModal('Çıkış yapılıyor...')" class="bg-red-600 text-white py-2 px-5 rounded-lg shadow-md hover:bg-red-700"><i class="fa-solid fa-right-from-bracket mr-2"></i>Çıkış</button>
            </footer>

        </main>
    </div>

    <!-- Bilgilendirme Modalı -->
    <div id="infoModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeInfoModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-fb-blue">Bilgilendirme</p>
                    <div onclick="closeInfoModal()" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <p id="infoModalText" class="text-gray-700"></p>
                <div class="flex justify-end pt-2">
                    <button onclick="closeInfoModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Onay Modalı (Silme işlemi için) -->
    <div id="confirmModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-red-600">Onay Gerekiyor</p>
                </div>
                <p id="confirmModalText" class="text-gray-700"></p>
                <div class="flex justify-end pt-4 gap-4">
                    <button id="confirmCancelBtn" class="px-4 bg-gray-300 p-2 rounded-lg text-gray-800 hover:bg-gray-400">İptal</button>
                    <button id="confirmOkBtn" class="px-4 bg-red-600 p-2 rounded-lg text-white hover:bg-red-700">Evet, Sil</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DEĞİŞKENLER VE SABİTELER ---
        const EXCEL_DOSYA_URL = 'https://raw.githubusercontent.com/gokhangeo/isyonetim/main/isyonetim.xlsx';

        const personelSec = document.getElementById('personelSec');
        const isTuru = document.getElementById('isTuru');
        const birim = document.getElementById('birim');
        const kayitListesi = document.getElementById('kayitListesi');
        const secilenPersoneller = document.getElementById('secilenPersoneller');
        
        let tumKayitlar = [];
        let personelListesi = [];
        let isListesi = [];
        let birimListesi = [];
        let silinecekKayitIndex = null;

        // --- MODAL YÖNETİMİ ---
        const infoModal = document.getElementById('infoModal');
        const infoModalText = document.getElementById('infoModalText');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');

        const closeInfoModal = () => {
            infoModal.classList.add('opacity-0', 'pointer-events-none');
        };
        window.showInfoModal = (text) => { // Global scope'a taşıdık
            infoModalText.textContent = text;
            infoModal.classList.remove('opacity-0', 'pointer-events-none');
        };
        
        const closeConfirmModal = () => {
            confirmModal.classList.add('opacity-0', 'pointer-events-none');
        };
        const showConfirmModal = (text, index) => {
            silinecekKayitIndex = index;
            confirmModalText.textContent = text;
            confirmModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        confirmOkBtn.addEventListener('click', () => {
            if (silinecekKayitIndex !== null) {
                tumKayitlar.splice(silinecekKayitIndex, 1);
                kayitListesiniGuncelle();
                showInfoModal("Kayıt başarıyla silindi.");
            }
            closeConfirmModal();
        });
        confirmCancelBtn.addEventListener('click', closeConfirmModal);

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInfoModal();
                closeConfirmModal();
            }
        });


        // --- EXCEL VERİ YÜKLEME ---
        const excelVerisiYukle = async () => {
            if (!EXCEL_DOSYA_URL) {
                showInfoModal('Excel dosya URL adresi tanımlanmamış.');
                kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">Excel URL'si yapılandırılmamış.</td></tr>`;
                return;
            }

            try {
                const response = await fetch(EXCEL_DOSYA_URL);
                if (!response.ok) throw new Error(`Ağ hatası: ${response.statusText}`);
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                // Veri listelerini dolduran yardımcı fonksiyon
                const loadSheetData = (sheetName, selectElement, list, placeholder) => {
                    const sheet = workbook.Sheets[sheetName];
                    if (sheet) {
                        list.splice(0, list.length, ...XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat().filter(Boolean));
                        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                        list.forEach(item => {
                            selectElement.innerHTML += `<option value="${item}">${item}</option>`;
                        });
                    } else {
                        showInfoModal(`'${sheetName}' adında bir Excel sayfası bulunamadı.`);
                        selectElement.innerHTML = `<option value="">${sheetName} Yüklenemedi</option>`;
                    }
                };

                loadSheetData('Personel', personelSec, personelListesi, 'Personel Seçiniz');
                loadSheetData('Isler', isTuru, isListesi, 'İş Türü Seçiniz');
                loadSheetData('Birim', birim, birimListesi, 'Birim Seçiniz');

                // Kayıtlar Sayfasını Yükle
                const kayitlarSheet = workbook.Sheets['Kayitlar'];
                 if (kayitlarSheet) {
                    tumKayitlar = XLSX.utils.sheet_to_json(kayitlarSheet);
                    kayitListesiniGuncelle();
                } else {
                     showInfoModal("'Kayitlar' adında bir Excel sayfası bulunamadı. Başlangıçta liste boş olacak.");
                     kayitListesiniGuncelle();
                }

            } catch (error) {
                console.error('Excel dosyası okunurken hata:', error);
                showInfoModal(`Excel dosyası okunurken bir hata oluştu: ${error.message}`);
                kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">Veri yüklenemedi.</td></tr>`;
            }
        };

        // --- KAYIT LİSTESİ GÜNCELLEME ---
        const kayitListesiniGuncelle = () => {
            kayitListesi.innerHTML = '';
            if (tumKayitlar.length === 0) {
                kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">Henüz kayıt eklenmemiş.</td></tr>`;
                return;
            }

            tumKayitlar.forEach((kayit, index) => {
                const row = `
                    <tr class="hover:bg-fb-yellow hover:bg-opacity-20">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${kayit['Kayıt No'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Personeller || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Birim || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.İş || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit['Dosya Sayısı'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit['Parsel Sayısı'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Tarih || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-red-600 hover:text-red-900" onclick="window.sil(${index})"><i class="fa-solid fa-trash-alt"></i> Sil</button>
                        </td>
                    </tr>
                `;
                kayitListesi.innerHTML += row;
            });
        };
        
        // Silme fonksiyonunu window objesine ekliyoruz ki modalden erişilebilsin
        window.sil = (index) => {
            showConfirmModal('Bu kaydı silmek istediğinizden emin misiniz?', index);
        };

        // --- EVENT LISTENERS ---
        document.getElementById('personelEkleBtn').addEventListener('click', () => {
            const secilen = personelSec.value;
            if (secilen && !secilenPersoneller.value.includes(secilen)) {
                secilenPersoneller.value += (secilenPersoneller.value ? '\n' : '') + secilen;
            }
        });

        document.getElementById('personelTemizleBtn').addEventListener('click', () => {
            secilenPersoneller.value = '';
        });
        
        document.getElementById('tarih').valueAsDate = new Date();

        document.getElementById('isiAktarBtn').addEventListener('click', () => {
            const yeniKayit = {
                'Kayıt No': document.getElementById('kayitNo').value,
                'Tarih': document.getElementById('tarih').value,
                'Birim': document.getElementById('birim').value,
                'Dosya Sayısı': document.getElementById('dosyaSayisi').value,
                'Parsel Sayısı': document.getElementById('parselSayisi').value,
                'İş': document.getElementById('isTuru').value,
                'Personeller': secilenPersoneller.value.replace(/\n/g, ', ')
            };

            if (!yeniKayit['Kayıt No'] || !yeniKayit['İş'] || !yeniKayit['Personeller'] || !yeniKayit['Birim']) {
                showInfoModal('Lütfen Kayıt No, Birim, İş Türü ve Personel alanlarını doldurun.');
                return;
            }

            tumKayitlar.unshift(yeniKayit);
            kayitListesiniGuncelle();
            
            // Formu temizle
            document.getElementById('kayitNo').value = '';
            document.getElementById('dosyaSayisi').value = '';
            document.getElementById('parselSayisi').value = '';
            document.getElementById('isTuru').selectedIndex = 0;
            document.getElementById('birim').selectedIndex = 0;
            secilenPersoneller.value = '';
            showInfoModal('Yeni iş kaydı başarıyla eklendi.');
        });

        document.getElementById('excelAktarBtn').addEventListener('click', () => {
            if (tumKayitlar.length === 0) {
                showInfoModal('Dışa aktarılacak kayıt bulunmuyor.');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(tumKayitlar);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'İş Listesi');
            
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            XLSX.writeFile(workbook, `Kadastro_Is_Listesi_${dateStr}.xlsx`);
        });

        // --- İLK YÜKLEME ---
        excelVerisiYukle();
    });
    </script>

</body>
</html>
