<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadastro İş Yönetim Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) Kütüphanesi CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome Ikonları için -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --fb-blue: #002D72;
            --fb-yellow: #FBB03B;
        }
        .bg-fb-blue { background-color: var(--fb-blue); }
        .bg-fb-yellow { background-color: var(--fb-yellow); }
        .text-fb-blue { color: var(--fb-blue); }
        .text-fb-yellow { color: var(--fb-yellow); }
        .border-fb-blue { border-color: var(--fb-blue); }
        .border-fb-yellow { border-color: var(--fb-yellow); }
        .btn-primary { background-color: var(--fb-blue); color: white; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #0041A1; }
        .btn-primary:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .btn-secondary { background-color: var(--fb-yellow); color: var(--fb-blue); font-weight: bold; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #FFC72C; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--fb-blue); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #0041A1; }
        .modal { transition: opacity 0.25s ease; z-index: 9999; }
        .spinner { border-top-color: var(--fb-yellow) !important; }
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Global Yükleme Göstergesi -->
    <div id="global-loader" class="hidden">
        <div class="flex flex-col items-center bg-white p-6 rounded-lg shadow-xl">
            <div class="spinner animate-spin rounded-full h-16 w-16 border-b-4 border-t-4 border-fb-blue"></div>
            <p id="loader-text" class="text-fb-blue mt-4 font-semibold">İşlem Yapılıyor...</p>
        </div>
    </div>


    <!-- Ana Konteyner -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Başlık -->
        <header class="bg-fb-blue text-white p-4 rounded-t-lg shadow-lg flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold"><i class="fa-solid fa-map-location-dot mr-2"></i>Kadastro İş Yönetim Sistemi</h1>
            <span class="text-xs font-mono">v2.0.0</span>
        </header>

        <!-- GitHub Ayar Alanı -->
        <div class="bg-white p-4 my-4 rounded-lg shadow-lg border border-gray-200">
             <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">GitHub Bağlantı Ayarları</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div>
                     <label for="githubOwner" class="block text-sm font-medium text-gray-700">Repo Sahibi</label>
                     <input type="text" id="githubOwner" value="gokhangeo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm bg-gray-100" readonly>
                 </div>
                 <div>
                     <label for="githubRepo" class="block text-sm font-medium text-gray-700">Repo Adı</label>
                     <input type="text" id="githubRepo" value="isyonetim" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm bg-gray-100" readonly>
                 </div>
                 <div>
                     <label for="githubPath" class="block text-sm font-medium text-gray-700">Dosya Yolu</label>
                     <input type="text" id="githubPath" value="isyonetim.xlsx" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm bg-gray-100" readonly>
                 </div>
                 <div class="md:col-span-3">
                     <label for="githubToken" class="block text-sm font-medium text-gray-700">GitHub Token</label>
                     <input type="password" id="githubToken" placeholder="GitHub Personal Access Token'ınızı buraya girin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm">
                 </div>
                 <div class="md:col-span-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="rememberToken" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-fb-blue focus:ring-fb-blue">
                        <label for="rememberToken" class="ml-2 block text-sm text-gray-900">Token'ı Hatırla</label>
                    </div>
                    <button id="loadDataBtn" class="btn-primary py-2 px-4 rounded-lg shadow-md"><i class="fa-solid fa-sync-alt mr-2"></i>Verileri Yükle</button>
                 </div>
             </div>
        </div>

        <main class="bg-white p-4 sm:p-6 lg:p-8 rounded-b-lg shadow-lg">
            <!-- Form Alanı -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3"><h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Yeni İş Kaydı</h3></div>
                    <div><label for="kayitNo" class="block text-sm font-medium text-gray-700">Kayıt No (MEGSİS)</label><input type="text" id="kayitNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                    <div><label for="tarih" class="block text-sm font-medium text-gray-700">Tarih</label><input type="date" id="tarih" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                    <div><label for="birim" class="block text-sm font-medium text-gray-700">Birim</label><select id="birim" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                    <div><label for="dosyaSayisi" class="block text-sm font-medium text-gray-700">Dosya Sayısı</label><input type="number" id="dosyaSayisi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                    <div><label for="parselSayisi" class="block text-sm font-medium text-gray-700">Parsel Sayısı</label><input type="number" id="parselSayisi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"></div>
                    <div class="sm:col-span-2 md:col-span-1"><label for="isTuru" class="block text-sm font-medium text-gray-700">İş Türü</label><select id="isTuru" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                    <div class="sm:col-span-2 md:col-span-3"><button id="isiAktarBtn" class="w-full btn-primary font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"><i class="fa-solid fa-plus mr-2"></i>İşi Ekle ve Kaydet</button></div>
                </div>
                <div class="lg:col-span-1 bg-gray-50 p-4 rounded-lg border">
                     <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">Personel Seçimi</h3>
                    <div><label for="personelSec" class="block text-sm font-medium text-gray-700">Personel</label><select id="personelSec" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm"><option>Yükleniyor...</option></select></div>
                    <div class="mt-2 flex gap-2"><button id="personelEkleBtn" class="flex-grow btn-secondary py-2 px-4 rounded-lg text-sm">Ekle <i class="fa-solid fa-arrow-down ml-1"></i></button></div>
                    <div class="mt-4"><label for="secilenPersoneller" class="block text-sm font-medium text-gray-700">Görevli Personeller</label><textarea id="secilenPersoneller" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fb-blue focus:ring-fb-blue sm:text-sm" readonly></textarea></div>
                     <div class="mt-2 flex gap-2"><button id="personelTemizleBtn" class="flex-grow bg-red-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-700">Temizle <i class="fa-solid fa-trash ml-1"></i></button></div>
                </div>
            </div>

            <!-- Kayıt Listesi -->
            <div>
                <h3 class="text-lg font-semibold text-fb-blue border-b-2 border-fb-yellow pb-2 mb-4">İş Listesi</h3>
                <div class="overflow-x-auto bg-white rounded-lg shadow mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-fb-blue">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Kayıt No</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Personeller</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Birim</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">İş</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Dosya Sayısı</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Parsel Sayısı</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Tarih</th><th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="kayitListesi" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="8" class="p-4 text-center text-gray-500">Veri yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <footer class="mt-8 pt-6 border-t-2 border-gray-200 flex flex-wrap gap-4 justify-center">
                <button id="excelIndirBtn" class="btn-secondary py-2 px-5 rounded-lg shadow-md"><i class="fa-solid fa-file-excel mr-2"></i>Excel'e İndir</button>
            </footer>
        </main>
    </div>

    <!-- Modallar -->
    <div id="infoModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0"><div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="window.closeInfoModal()"></div><div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"><div class="modal-content py-4 text-left px-6"><div class="flex justify-between items-center pb-3"><p class="text-2xl font-bold text-fb-blue">Bilgilendirme</p><div onclick="window.closeInfoModal()" class="cursor-pointer z-50"><svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg></div></div><p id="infoModalText" class="text-gray-700"></p><div class="flex justify-end pt-2"><button onclick="window.closeInfoModal()" class="px-4 bg-fb-blue p-2 rounded-lg text-white hover:bg-fb-yellow hover:text-fb-blue">Tamam</button></div></div></div></div>
    <div id="confirmModal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0"><div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div><div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"><div class="modal-content py-4 text-left px-6"><div class="flex justify-between items-center pb-3"><p class="text-2xl font-bold text-red-600">Onay Gerekiyor</p></div><p id="confirmModalText" class="text-gray-700"></p><div class="flex justify-end pt-4 gap-4"><button id="confirmCancelBtn" class="px-4 bg-gray-300 p-2 rounded-lg text-gray-800 hover:bg-gray-400">İptal</button><button id="confirmOkBtn" class="px-4 bg-red-600 p-2 rounded-lg text-white hover:bg-red-700">Evet, Sil</button></div></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DEĞİŞKENLER ---
        const githubOwnerInput = document.getElementById('githubOwner');
        const githubRepoInput = document.getElementById('githubRepo');
        const githubPathInput = document.getElementById('githubPath');
        const githubTokenInput = document.getElementById('githubToken');
        const rememberTokenCheckbox = document.getElementById('rememberToken');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const globalLoader = document.getElementById('global-loader');
        const loaderText = document.getElementById('loader-text');
        
        const personelSec = document.getElementById('personelSec');
        const isTuru = document.getElementById('isTuru');
        const birim = document.getElementById('birim');
        const kayitListesi = document.getElementById('kayitListesi');
        const secilenPersoneller = document.getElementById('secilenPersoneller');
        
        let tumKayitlar = [];
        let personelListesi = [], isListesi = [], birimListesi = [];
        let originalWorkbook = null;
        let fileSHA = null;
        let silinecekKayitIndex = null;
        let isDataLoaded = false;

        // --- YARDIMCI FONKSİYONLAR ---
        const showLoader = (text = "İşlem Yapılıyor...") => { loaderText.textContent = text; globalLoader.classList.remove('hidden'); };
        const hideLoader = () => { globalLoader.classList.add('hidden'); };

        const infoModal = document.getElementById('infoModal');
        const infoModalText = document.getElementById('infoModalText');
        window.closeInfoModal = () => infoModal.classList.add('opacity-0', 'pointer-events-none');
        window.showInfoModal = (text, isError = false) => {
            infoModalText.textContent = text;
            infoModal.querySelector('p.text-2xl').className = isError ? "text-2xl font-bold text-red-600" : "text-2xl font-bold text-fb-blue";
            infoModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        const closeConfirmModal = () => confirmModal.classList.add('opacity-0', 'pointer-events-none');
        window.showConfirmModal = (text, index) => {
            silinecekKayitIndex = index;
            confirmModalText.textContent = text;
            confirmModal.classList.remove('opacity-0', 'pointer-events-none');
        };
        
        const getApiUrl = () => `https://api.github.com/repos/${githubOwnerInput.value}/${githubRepoInput.value}/contents/${githubPathInput.value}`;

        // --- ANA FONKSİYONLAR ---
        const excelVerisiYukle = async () => {
            const GITHUB_TOKEN = githubTokenInput.value;
            if (!GITHUB_TOKEN) {
                window.showInfoModal("Lütfen GitHub Token'ınızı girin.", true);
                return;
            }
            
            if (rememberTokenCheckbox.checked) {
                localStorage.setItem('githubToken', GITHUB_TOKEN);
            } else {
                localStorage.removeItem('githubToken');
            }

            showLoader("Veriler GitHub'dan yükleniyor...");
            try {
                const response = await fetch(getApiUrl(), { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
                if (!response.ok) throw new Error(`GitHub'dan dosya alınamadı: ${response.statusText}`);
                const data = await response.json();
                fileSHA = data.sha;

                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
                
                originalWorkbook = XLSX.read(bytes, { type: 'array' });
                
                const loadSheetData = (sheetName, selectElement, list, placeholder) => {
                    const sheet = originalWorkbook.Sheets[sheetName];
                    if (sheet) {
                        list.splice(0, list.length, ...XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat().filter(Boolean));
                        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                        list.forEach(item => selectElement.innerHTML += `<option value="${item}">${item}</option>`);
                    } else {
                        window.showInfoModal(`'${sheetName}' adında bir Excel sayfası bulunamadı.`, true);
                    }
                };
                
                loadSheetData('Personel', personelSec, personelListesi, 'Personel Seçiniz');
                loadSheetData('İşler', isTuru, isListesi, 'İş Türü Seçiniz');
                loadSheetData('Birim', birim, birimListesi, 'Birim Seçiniz');

                const kayitlarSheet = originalWorkbook.Sheets['Kayitlar'];
                tumKayitlar = kayitlarSheet ? XLSX.utils.sheet_to_json(kayitlarSheet) : [];
                kayitListesiniGuncelle();
                isDataLoaded = true;
                window.showInfoModal("Veriler GitHub'dan başarıyla yüklendi.");

            } catch (error) {
                console.error('Excel dosyası okunurken hata:', error);
                window.showInfoModal(`Excel dosyası okunurken bir hata oluştu: ${error.message}`, true);
                kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">Veri yüklenemedi. Token'ı kontrol edin.</td></tr>`;
                isDataLoaded = false;
            } finally {
                hideLoader();
            }
        };
        
        const saveDataToGithub = async (dataToSave, actionText) => {
            if (!isDataLoaded) {
                window.showInfoModal("Önce verilerin yüklenmesi gerekiyor.", true);
                return { success: false };
            }
            const GITHUB_TOKEN = githubTokenInput.value;
            if (!GITHUB_TOKEN || !fileSHA) {
                window.showInfoModal("GitHub Token veya dosya bilgisi (SHA) eksik.", true);
                return { success: false };
            }

            try {
                const workbookToSave = XLSX.utils.book_new();
                
                Object.keys(originalWorkbook.Sheets).forEach(sheetName => {
                    if (sheetName !== 'Kayitlar') {
                        XLSX.utils.book_append_sheet(workbookToSave, originalWorkbook.Sheets[sheetName], sheetName);
                    }
                });

                const newKayitlarSheet = XLSX.utils.json_to_sheet(dataToSave);
                XLSX.utils.book_append_sheet(workbookToSave, newKayitlarSheet, 'Kayitlar');

                const newWorkbookBinary = XLSX.write(workbookToSave, { bookType: 'xlsx', type: 'binary' });
                const newContentBase64 = btoa(newWorkbookBinary);
                
                const response = await fetch(getApiUrl(), {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `[Kadastro App] ${actionText} - ${new Date().toLocaleString()}`,
                        content: newContentBase64,
                        sha: fileSHA
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub'a kaydetme başarısız: ${errorData.message}`);
                }
                
                const responseData = await response.json();
                const newSHA = responseData.content.sha;
                
                window.showInfoModal(`Başarılı: ${actionText} GitHub'a kaydedildi!`);
                return { success: true, newSHA: newSHA, newWorkbook: workbookToSave };
            } catch (error) {
                console.error("GitHub'a kaydetme hatası:", error);
                window.showInfoModal(`Hata: ${error.message}. Değişiklikleriniz kaydedilemedi.`, true);
                return { success: false };
            }
        };
        
        const kayitListesiniGuncelle = () => {
            kayitListesi.innerHTML = '';
            if (tumKayitlar.length === 0) {
                kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">Kayıt bulunmuyor.</td></tr>`;
                return;
            }
            tumKayitlar.forEach((kayit, index) => {
                const row = `
                    <tr class="hover:bg-fb-yellow hover:bg-opacity-20">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${kayit['Kayıt No'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Personeller || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Birim || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.İş || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit['Dosya Sayısı'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit['Parsel Sayısı'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${kayit.Tarih || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-red-600 hover:text-red-900" onclick="window.sil(${index})"><i class="fa-solid fa-trash-alt"></i> Sil</button>
                        </td>
                    </tr>`;
                kayitListesi.innerHTML += row;
            });
        };
        
        window.sil = (index) => {
            window.showConfirmModal(`'${tumKayitlar[index]['Kayıt No']}' numaralı kaydı silmek istediğinizden emin misiniz? Bu işlem anında GitHub'a kaydedilecektir.`, index);
        };

        // --- EVENT LISTENERS ---
        loadDataBtn.addEventListener('click', excelVerisiYukle);
        
        document.getElementById('confirmOkBtn').addEventListener('click', async () => {
            if (silinecekKayitIndex !== null) {
                const indexToRemove = silinecekKayitIndex;
                silinecekKayitIndex = null;
                closeConfirmModal();

                const kayitAdi = tumKayitlar[indexToRemove]['Kayıt No'];
                const guncelListe = tumKayitlar.filter((_, index) => index !== indexToRemove);
                
                showLoader("Kayıt siliniyor ve kaydediliyor...");
                const result = await saveDataToGithub(guncelListe, `Kayıt Silindi: ${kayitAdi}`);
                hideLoader();
                
                if (result.success) {
                    tumKayitlar = guncelListe;
                    fileSHA = result.newSHA;
                    originalWorkbook = result.newWorkbook;
                    kayitListesiniGuncelle();
                }
            }
        });
        document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmModal);

        document.getElementById('isiAktarBtn').addEventListener('click', async () => {
            const yeniKayit = {
                'Kayıt No': document.getElementById('kayitNo').value,
                'Tarih': document.getElementById('tarih').value,
                'Birim': document.getElementById('birim').value,
                'Dosya Sayısı': document.getElementById('dosyaSayisi').value,
                'Parsel Sayısı': document.getElementById('parselSayisi').value,
                'İş': document.getElementById('isTuru').value,
                'Personeller': secilenPersoneller.value.replace(/\n/g, ', ')
            };
            if (!yeniKayit['Kayıt No'] || !yeniKayit['İş'] || !yeniKayit['Personeller'] || !yeniKayit['Birim']) {
                window.showInfoModal('Lütfen Kayıt No, Birim, İş Türü ve Personel alanlarını doldurun.', true);
                return;
            }
            
            const guncelListe = [yeniKayit, ...tumKayitlar];
            
            showLoader("Yeni kayıt ekleniyor ve kaydediliyor...");
            const result = await saveDataToGithub(guncelListe, `Yeni Kayıt Eklendi: ${yeniKayit['Kayıt No']}`);
            hideLoader();

            if (result.success) {
                tumKayitlar = guncelListe;
                fileSHA = result.newSHA;
                originalWorkbook = result.newWorkbook;
                kayitListesiniGuncelle();

                document.getElementById('kayitNo').value = '';
                document.getElementById('dosyaSayisi').value = '';
                document.getElementById('parselSayisi').value = '';
                document.getElementById('isTuru').selectedIndex = 0;
                document.getElementById('birim').selectedIndex = 0;
                secilenPersoneller.value = '';
            }
        });
        
        document.getElementById('excelIndirBtn').addEventListener('click', () => {
            if (tumKayitlar.length === 0) {
                window.showInfoModal('İndirilecek kayıt bulunmuyor.', true); return;
            }
            const worksheet = XLSX.utils.json_to_sheet(tumKayitlar);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'İş Listesi');
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            XLSX.writeFile(workbook, `Kadastro_Is_Listesi_${dateStr}.xlsx`);
        });

        document.getElementById('personelEkleBtn').addEventListener('click', () => { const secilen = personelSec.value; if (secilen && !secilenPersoneller.value.includes(secilen)) { secilenPersoneller.value += (secilenPersoneller.value ? '\n' : '') + secilen; } });
        document.getElementById('personelTemizleBtn').addEventListener('click', () => { secilenPersoneller.value = ''; });
        document.getElementById('tarih').valueAsDate = new Date();

        // Sayfa yüklendiğinde token'ı al ama veriyi otomatik yükleme
        const savedToken = localStorage.getItem('githubToken');
        if (savedToken) {
            githubTokenInput.value = savedToken;
            rememberTokenCheckbox.checked = true;
        }
        
        kayitListesi.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-orange-500">Başlamak için lütfen GitHub Token'ınızı girin ve 'Verileri Yükle' butonuna basın.</td></tr>`;
        
    });
    </script>
</body>
</html>
